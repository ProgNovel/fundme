"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function isMultiplePointer(e){return Array.isArray(e)}function setWebMonetizationPointer(e){return setWebMonetizationTag(document.querySelector('meta[name="monetization"]'),e)}function setWebMonetizationTag(e,t){return e?e.content=t:e=createWebMonetizationTag(t),e}function createWebMonetizationTag(e){var t=document.createElement("meta");return t.name="monetization",t.content=e,document.head.appendChild(t),t}function getPoolWeightSum(e){var t=e.map(function(e){return e.weight});return Object.values(t).reduce(function(e,t){return e+t},0)}function getWinningPointer(e,t){for(var n in e){if((t-=e[n].weight)<=0)return e[n]}}function setPointerSingle(e){setWebMonetizationPointer(e)}Object.defineProperty(exports,"__esModule",{value:!0});var defaultAddressNotFound="Fundme.js: default address not found. Use setDefaultAddress(str: string) to set it first.",invalidAddress="Fundme.js: Invalid Web Monetization pointer address is given.",addressNotFound="Fundme.js: address not found.",addressIsNotAString="Fundme.js: address must be a string.";function weightIsNotANumber(e){return"Fundme.js: "+e+" has weight that is not a number. It has been set to "+DEFAULT_WEIGHT+" (default)."}var noTemplateFound="Fundme.js: no monetization template is found.",failParsingTemplate="Fundme.js: fails to parse address from <template data-fund></template>.",cannotParseScriptJson="Fundme.js: cannot parse JSON from <script fundme>. Make sure it contains a valid JSON.",jsonTemplateIsInvalid="Fundme.js: found <script fundme> but it's not an array.",scriptFundmeIsNotApplicationJson='Fundme.js: found <script fundme> but its type is not "application/json"',DEFAULT_WEIGHT=5;function setPointerMultiple(e){setWebMonetizationPointer(getPointerAddress(pickPointer(createPool(e))))}function getPointerAddress(e){var t=e.address;if(!t)throw new Error(addressNotFound);if("string"!=typeof t)throw new Error(addressIsNotAString);return t}function createPool(e){return e.map(function(e){if("string"==typeof e&&(e=convertToPointer(e)),!("address"in e))throw new Error(addressNotFound);return checkWeight(e)})}function checkWeight(e){return void 0!==e.weight&&NaN!==e.weight||(console.warn(weightIsNotANumber(e.address)),e.weight=DEFAULT_WEIGHT),e}function pickPointer(e){return getWinningPointer(e,getChoice(getPoolWeightSum(e)))}function getChoice(e){return Math.random()*e}function convertToPointer(e){var t=e,n=void 0,r=e.split("#");return r.length>1&&(t=r[0],n=parseInt(r[1],10)),{address:t,weight:n||DEFAULT_WEIGHT}}var FUNDME_TEMPLATE_SELECTOR="template[data-fund]",FUNDME_JSON_SELECTOR="script[fundme]";function setPointerFromTemplates(){var e=[].concat(_toConsumableArray(scrapeTemplate()),_toConsumableArray(scrapeJson()));if(!e.length)throw new Error(noTemplateFound);setPointerMultiple(e)}function scrapeJson(){var e=document.body.querySelectorAll(FUNDME_JSON_SELECTOR),t=[];return e.length&&e.forEach(function(e){t=parseScriptJson(e)}),t}function parseScriptJson(e){var t=[],n=void 0;try{n=JSON.parse(e.innerHTML)}catch(e){throw new Error(cannotParseScriptJson)}if("application/json"!==e.type)throw new Error(scriptFundmeIsNotApplicationJson);if(Array.isArray(n))t=createPool(n);else{if("string"!=typeof n)throw new Error(jsonTemplateIsInvalid);t=createPool([n])}return t}function scrapeTemplate(){var e=document.body.querySelectorAll(FUNDME_TEMPLATE_SELECTOR),t=[];return e.length&&e.forEach(function(e){var n=parseTemplate(e);t=[].concat(_toConsumableArray(t),[n])}),t}function parseTemplate(e){var t=e.dataset.fund,n=void 0!==e.dataset.fundWeight?parseInt(e.dataset.fundWeight,0):DEFAULT_WEIGHT;if(!t)throw new Error(failParsingTemplate);return checkWeight({address:t,weight:n})}var FundType,defaultAddress=void 0,currentFundType=void 0;function fund(e,t){if("string"==typeof e){if("default"===e){if(void 0!==defaultAddress)return"string"==typeof defaultAddress?setPointerSingle(defaultAddress):setPointerMultiple(defaultAddress),setFundType(FundType.isDefault);throw new Error(defaultAddressNotFound)}return setPointerSingle(e),setFundType(FundType.isSingle)}if(isMultiplePointer(e))return setPointerMultiple(e),setFundType(FundType.isMultiple);if(void 0===e)return setPointerFromTemplates(),setFundType(FundType.isFromTemplate);throw new Error(invalidAddress)}function setDefaultAddress(e){defaultAddress=Array.isArray(e)?createPool(e):e}function setFundType(e){return currentFundType=e}!function(e){e.isSingle="single",e.isMultiple="multiple",e.isDefault="default",e.isFromTemplate="template",e.isUndefined="undefined"}(FundType||(FundType={})),exports.fund=fund,exports.setDefaultAddress=setDefaultAddress;
