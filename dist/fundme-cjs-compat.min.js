"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function calculateRelativeWeight(e,t){return 0}function FundmeError(e){return"Fundme.js: "+e}Object.defineProperty(exports,"__esModule",{value:!0});var addressNotFound="address not found.",addressIsNotAString="address must be a string.",getCurrentPointerAddressMustClientSide="can't use getCurrentPointerAddress() server-side.";function weightIsNotANumber(e){return e+" has weight that is not a number. It has been set to "+DEFAULT_WEIGHT+" (default)."}var invalidAddress="invalid Web Monetization pointer address is given.",defaultAddressNotFound="default address not found. Use setDefaultAddress(str: string) to set it first.",invalidDefaultAddress="invalid default address.",defaultAddressArrayCannotBeEmpty="invalid default address.",canOnlyCleanStringCustomSyntax="can only clean custom syntax with typeof string.",metaTagNotFound="web monetization meta tag is not found.",metaTagMultipleIsFound='multiple <meta name="monetization" /> found - Web Monetization API only support a single meta tag.',noTemplateFound="no monetization template is found.",failParsingTemplate="fails to parse address from <template data-fund></template>.",cannotParseScriptJson="cannot parse JSON from <script fundme>. Make sure it contains a valid JSON.",jsonTemplateIsInvalid="found <script fundme> but it's not valid.",scriptFundmeIsNotApplicationJson='found <script fundme> but its type is not "application/json"',noUndefinedFundOnServerSide="can't use fund() with empty parameters in server side.",invalidFundmeServerSide="invalid fundme parameters on the server-side.",DEFAULT_WEIGHT=5;function setPointerMultiple(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=createPool(e),n=getPointerAddress(pickPointer(r));return setCurrentPointer(r),isBrowser(t)?setWebMonetizationPointer(n):n}function getPointerAddress(e){var t=e.address;if(!t)throw FundmeError(addressNotFound);if("string"!=typeof t)throw FundmeError(addressIsNotAString);return t}function createPool(e){return e.map(function(e){if("string"==typeof e&&(e=convertToPointer(e)),!hasAddress(e))throw FundmeError(addressNotFound);return checkWeight(e)})}function checkWeight(e){return void 0!==e.weight&&NaN!==e.weight||(console.warn(weightIsNotANumber(e.address)),e.weight=DEFAULT_WEIGHT),e}function pickPointer(e){return getWinningPointer(e,getChoice(getPoolWeightSum(e)))}function getChoice(e){return Math.random()*e}function convertToPointer(e){var t=e,r=DEFAULT_WEIGHT,n=e.split("#");return n.length>1&&(t=n[0],n[1].endsWith("%")?calculateRelativeWeight(n[1],getCurrentPointerPool()):r=parseInt(n[1],10)),checkWeight({address:t,weight:r})}function isMultiplePointer(e){return Array.isArray(e)}function setWebMonetizationPointer(e){return setWebMonetizationTag(document.head.querySelector('meta[name="monetization"]'),e)}function setWebMonetizationTag(e,t){return e?e.content=t:e=createWebMonetizationTag(t),e}function createWebMonetizationTag(e){var t=document.createElement("meta");return t.name="monetization",t.content=e,document.head.appendChild(t),t}function getPoolWeightSum(e){var t=e.map(function(e){return e.weight||DEFAULT_WEIGHT});return Object.values(t).reduce(function(e,t){return e+t},0)}function getWinningPointer(e,t){for(var r in e){if((t-=e[r].weight||DEFAULT_WEIGHT)<=0)return e[r]}return{address:""}}function hasAddress(e){return!!e&&Object.keys(e).some(function(e){return"address"===e})}var defaultAddress=void 0;function setDefaultAddress(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Array.isArray(e)){if(e.length)return void(defaultAddress=createPool(e));throw FundmeError(defaultAddressArrayCannotBeEmpty)}if("string"!=typeof e)if(hasAddress(e))defaultAddress=getPointerAddress(e);else{if(!t.allowUndefined||void 0!==e)throw FundmeError(invalidDefaultAddress);defaultAddress=void 0}else defaultAddress=e}function getDefaultAddress(){return defaultAddress}function defaultAddressMultiple(e){return isMultiplePointer(e)?e:[e]}var currentFundType=void 0;function setFundType(e){return currentFundType=e}var currentPointer=void 0;function setCurrentPointer(e){currentPointer=e}function getCurrentPointerAddress(){if(isBrowser()){var e=document.head.querySelectorAll('meta[name="monetization"]');if(e.length>1)throw FundmeError(metaTagMultipleIsFound);if(e[0])return e[0].content;throw FundmeError(metaTagNotFound)}if(currentPointer)return currentPointer.toString();throw FundmeError(getCurrentPointerAddressMustClientSide)}function cleanSinglePointerSyntax(e){if("string"!=typeof e)throw FundmeError(canOnlyCleanStringCustomSyntax);return e=e.split("#")[0]}function getCurrentPointerPool(){return convertToPointerPool(currentPointer)}function convertToPointerPool(e){return Array.isArray(e)||void 0===e||(e=[e]),e||[]}function setPointerSingle(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return setCurrentPointer(e=cleanSinglePointerSyntax(e)),isBrowser(t)?setWebMonetizationPointer(e):e}var FUNDME_TEMPLATE_SELECTOR="template[data-fund]",FUNDME_CUSTOM_SYNTAX_SELECTOR="template[fundme]",FUNDME_JSON_SELECTOR="script[fundme]";function setPointerFromTemplates(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=[].concat(_toConsumableArray(scrapeTemplate()),_toConsumableArray(scrapeJson()),_toConsumableArray(scrapeCustomSyntax()));if(!t.length)throw FundmeError(noTemplateFound);setPointerMultiple(t,e)}function scrapeJson(){var e=document.body.querySelectorAll(FUNDME_JSON_SELECTOR),t=[];return e.length&&e.forEach(function(e){t=parseScriptJson(e)}),t}function parseScriptJson(e){var t=[],r=void 0;try{r=JSON.parse(e.innerHTML)}catch(e){throw FundmeError(cannotParseScriptJson)}if("application/json"!==e.type)throw FundmeError(scriptFundmeIsNotApplicationJson);if(Array.isArray(r))t=createPool(r);else{if("string"!=typeof r)throw FundmeError(jsonTemplateIsInvalid);t=createPool([r])}return t}function scrapeTemplate(){var e=document.body.querySelectorAll(FUNDME_TEMPLATE_SELECTOR),t=[];return e.length&&e.forEach(function(e){var r=parseTemplate(e);t=[].concat(_toConsumableArray(t),[r])}),t}function parseTemplate(e){var t=e.dataset.fund,r=void 0!==e.dataset.fundWeight?parseInt(e.dataset.fundWeight,0):DEFAULT_WEIGHT;if(!t)throw FundmeError(failParsingTemplate);return checkWeight({address:t,weight:r})}function scrapeCustomSyntax(){var e=document.querySelectorAll(FUNDME_CUSTOM_SYNTAX_SELECTOR),t=[];return e.length&&e.forEach(function(e){t=[].concat(_toConsumableArray(t),_toConsumableArray(parseCustomSyntax(e)))}),t}function parseCustomSyntax(e){var t=[];return e.innerHTML.split(";").forEach(function(e){var r=e.replace(/(^\s+|\s+$)/g,"");r&&(t=[].concat(_toConsumableArray(t),[convertToPointer(r)]))}),t}function clientSideFund(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e)return setPointerFromTemplates(),setFundType(FundType.isFromTemplate);if("string"==typeof e){if("default"===e){if(void 0!==getDefaultAddress())return"string"==typeof getDefaultAddress()?setPointerSingle(getDefaultAddress().toString(),t):setPointerMultiple(defaultAddressMultiple(getDefaultAddress()),t),setFundType(FundType.isDefault);throw FundmeError(defaultAddressNotFound)}return setPointerSingle(e,t),setFundType(FundType.isSingle)}if(isMultiplePointer(e))return setPointerMultiple(e,t),setFundType(FundType.isMultiple);throw FundmeError(invalidAddress)}var FundType,forceBrowser=!1,isNodeEnv=void 0!==require&&void 0!==module,isBrowser=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("server"===e.force)return!1;var t=forceBrowser;return forceBrowser=!1,!isNodeEnv||t||"client"===e.force};function serverSideFund(e){if(void 0===e)throw FundmeError(noUndefinedFundOnServerSide);if("string"==typeof e)return setPointerSingle(e).toString();if(isMultiplePointer(e))return setPointerMultiple(e).toString();throw FundmeError(invalidFundmeServerSide)}function fund(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(isBrowser(t))return clientSideFund(e,t);if(void 0===e)throw FundmeError(noUndefinedFundOnServerSide);return serverSideFund(e)}!function(e){e.isSingle="single",e.isMultiple="multiple",e.isDefault="default",e.isFromTemplate="template",e.isUndefined="undefined"}(FundType||(FundType={})),exports.fund=fund,exports.getCurrentPointerAddress=getCurrentPointerAddress,exports.getCurrentPointerPool=getCurrentPointerPool,exports.setDefaultAddress=setDefaultAddress;
